<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChatKit Professional Agent</title>
    <!-- Load ChatKit Web Component -->
    <script src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js" async></script>
    <style>
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            display: flex; 
            justify-content: flex-end; /* Align to right */
            align-items: center; 
            height: 100vh; 
            background: #f0f2f5; 
            overflow: hidden;
        }
        
        #chat-container { 
            width: 100%; 
            max-width: 600px; 
            height: 100vh; /* Full height */
            background: transparent; /* Remove background */
            border-radius: 0 !important; /* Force pointy corners */
            box-shadow: none; /* Remove shadow */
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            border-left: 1px solid rgba(0,0,0,0.05); /* Optional subtle separator */
        }

        /* Ensure the custom element fills the container */
        openai-chatkit { 
            display: block; 
            height: 100%; 
            width: 100%; 
        }

        .theme-toggle {
            position: absolute;
            top: 10px;
            left: 10px; /* Move to left */
            width: 40px;
            height: 40px;
            border-radius: 30%;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .theme-toggle:hover {
            background: rgba(0,0,0,0.08);
            color: #000;
        }

        .reset-btn {
            position: absolute;
            top: 16px;
            left: 60px; /* Positioned after the toggle */
            padding: 6px 12px;
            border-radius: 99px;
            border: 1px solid rgba(0,0,0,0.1);
            background: transparent;
            cursor: pointer;
            font-size: 13px;
            color: #666;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .reset-btn:hover {
            background: rgba(0,0,0,0.05);
            color: #000;
        }

        .hero-text {
            position: absolute;
            top: 50%;
            left: calc(50% - 300px); /* Center in the remaining space (page width - chat width) */
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: 700;
            color: #424242;
            opacity: 0.5;
            pointer-events: none;
            text-align: center;
            line-height: 1.1;
            z-index: 0;
        }
    </style>
</head>
<body>

<button id="theme-btn" class="theme-toggle"></button>
<button id="reset-btn" class="reset-btn">Reset</button>

<div class="hero-text">
    ChatKit<br>Assistant
</div>

<div id="chat-container">
    <openai-chatkit id="chat"></openai-chatkit>
</div>

<script type="module">
    // 1. Wait for the component to be ready
    await customElements.whenDefined('openai-chatkit');
    const chat = document.getElementById('chat');

    // 2. Identify Unique User (Iframe-safe persistence)
    let userId = localStorage.getItem('chatkit_user_id');
    if (!userId) {
        userId = 'user_' + Math.random().toString(36).substring(2, 11);
        localStorage.setItem('chatkit_user_id', userId);
    }

    // 3. Mock Data for @-mention Entity Search
    const MOCK_ENTITIES = [
        { id: "order_123", title: "Order #123 (Shipped)", group: "Active Orders", icon: "lucide:package", interactive: true, data: { type: 'order' } },
        { id: "order_456", title: "Order #456 (Processing)", group: "Active Orders", icon: "lucide:clock", interactive: true, data: { type: 'order' } },
        { id: "doc_policy", title: "Return Policy", group: "Documentation", icon: "document", interactive: true, data: { type: 'doc' } },
        { id: "doc_shipping", title: "Shipping Rates", group: "Documentation", icon: "document", interactive: true, data: { type: 'doc' } }
    ];

// 4. Define Initial Options
    let currentOptions = {
        api: {
            url: 'http://localhost:8000/chatkit',
            fetch: (url, options) => {
                options.headers = { ...options.headers, 'X-ChatKit-User': userId };
                return fetch(url, options);
            },
            uploadStrategy: { type: 'direct', uploadUrl: 'http://localhost:8000/upload' },
            domainKey: 'local-dev' 
        },
        theme: {
            colorScheme: 'light',
            radius: 'pill',
            typography: {
                baseSize: 16,
                fontFamily: '"OpenAI Sans", system-ui, sans-serif',
                fontFamilyMono: 'ui-monospace, Consolas, monospace',
                fontSources: [
                    {
                        family: 'OpenAI Sans',
                        src: 'https://cdn.openai.com/common/fonts/openai-sans/v2/OpenAISans-Regular.woff2',
                        weight: 400,
                        style: 'normal',
                        display: 'swap'
                    }
                ]
            }
        },
        startScreen: {
            greeting: "Hello! I'm your ChatKit Powered Agent.",
            prompts: [
                { label: "Search AI News", prompt: "Search the web for the latest news on OpenAI ChatKit", icon: "lucide:search" },
                { label: "Analyze Sales", prompt: "Analyze sales performance for North America.", icon: "lucide:bar-chart" },
                { label: "Customize UI", prompt: "I want a new theme. Make it dark mode with a purple neon style and sharp corners.", icon: "lucide:palette" },
                { label: "Check Weather", prompt: "What is the weather in San Francisco?", icon: "lucide:sun" },
                { label: "Generate Image", prompt: "Generate an image of a futuristic city", icon: "lucide:image" },
                { label: "Research AI Models", prompt: "Do a deep research on the latest advancements in AI models and present the report.", icon: "lucide:book-open" }
            ]
        },
        composer: {
            placeholder: "Ask me to search, generate images, or change the UI...",
            dictation: { enabled: true },
            attachments: { enabled: true },
            tools: [
                { id: "web_search", label: "Web Search", icon: "lucide:globe" },
                { id: "get_weather", label: "Weather", icon: "lucide:sun" },
                { id: "preview_theme", label: "Theme Creation", icon: "lucide:paintbrush" }
            ],
            models: [
                { id: "gpt-4o-mini", label: "GPT 4o Mini" , description: "Smaller and faster", default: true },
                { id: "gpt-5.1", label: "GPT 5.1", description: "Latest and powerful" }
            ]
        },
        history: {
            enabled: true,
            showDelete: true,
            showRename: true
        },
        threadItemActions: {
            retry: true,
            feedback: true
        },
        entities: {
            showComposerMenu: true,
            onTagSearch: async (query) => {
                const q = query.toLowerCase();
                return MOCK_ENTITIES.filter(e => e.title.toLowerCase().includes(q));
            },
            onClick: (entity) => {
                console.log("User clicked entity:", entity);
            },
            onRequestPreview: async (entity) => {
                // Returns a rich preview widget for the entity
                return {
                    preview: {
                        type: 'Basic',
                        children: [
                            { type: 'Title', value: entity.title, size: 'sm' },
                            { type: 'Text', value: `Database ID: ${entity.id}`, size: 'sm', color: 'secondary' },
                            { type: 'Text', value: "Click to open full records in dashboard.", size: 'xs' }
                        ]
                    }
                };
            }
        }
    };

    // 5. Initialize Chat
    chat.setOptions(currentOptions);
    
    // Load initial fonts
    if (currentOptions.theme && currentOptions.theme.typography && currentOptions.theme.typography.fontSources) {
        loadDynamicFonts(currentOptions.theme.typography.fontSources);
    }

    // Theme Toggle Logic
    const themeBtn = document.getElementById('theme-btn');
    const resetBtn = document.getElementById('reset-btn');
    
    // Store default theme to allow resetting
    const defaultTheme = JSON.parse(JSON.stringify(currentOptions.theme));

    function updateThemeState() {
        // ... (existing updateThemeState logic)
        // If theme is not set, default to light
        const theme = currentOptions.theme || {};
        const isDark = (theme.colorScheme === 'dark');
        const radius = theme.radius || 'lg';
        
        // 1. Handle Icons
        const iconSun = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>`;
        const iconMoon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>`;

        // 2. Update Toggle Button
        themeBtn.innerHTML = isDark ? iconSun : iconMoon;
        
        if (isDark) {
            themeBtn.style.color = '#ccc';
            themeBtn.onmouseover = () => { themeBtn.style.background = 'rgba(255,255,255,0.1)'; themeBtn.style.color = '#fff'; };
            themeBtn.onmouseout = () => { themeBtn.style.background = 'transparent'; themeBtn.style.color = '#ccc'; };
            
            // Update Reset Button for Dark Mode
            resetBtn.style.borderColor = '#444';
            resetBtn.style.color = '#888';
        } else {
            themeBtn.style.color = '#666';
            themeBtn.onmouseover = () => { themeBtn.style.background = 'rgba(0,0,0,0.08)'; themeBtn.style.color = '#000'; };
            themeBtn.onmouseout = () => { themeBtn.style.background = 'transparent'; themeBtn.style.color = '#666'; };

            // Update Reset Button for Light Mode
            resetBtn.style.borderColor = 'rgba(0,0,0,0.1)';
            resetBtn.style.color = '#666';
        }
        
        // 3. Update Page Background
        let bg = isDark ? '#111' : '#f0f2f5';
        
        // If the theme provides granular color controls (from 'preview_theme' tool)
        // We can derive a harmonious background color from the grayscale hue.
        let accentColor = '#666'; // Default accent for reset button
        if (theme.color && theme.color.grayscale) {
            const hue = theme.color.grayscale.hue || 210;
            if (isDark) {
                // Dark mode: Very dark desaturated version of the hue
                bg = `hsl(${hue}, 20%, 10%)`;
                accentColor = theme.color.accent?.primary || '#888';
            } else {
                // Light mode: Very light desaturated version of the hue
                bg = `hsl(${hue}, 20%, 96%)`;
                accentColor = theme.color.accent?.primary || '#666';
            }
        }
        
        document.body.style.background = bg;

        // 4. Update Hero Text Font
        const heroText = document.querySelector('.hero-text');
        if (theme.typography && theme.typography.fontFamily) {
            heroText.style.fontFamily = theme.typography.fontFamily;
        }

        // 5. Update Reset Button Style (Radius & Accent)
        const radiusMap = {
            'none': '0px',
            'sharp': '0px',
            '0': '0px',
            'sm': '8px',
            'md': '12px',
            'lg': '16px',
            'xl': '24px',
            'pill': '99px', 
            'full': '99px'
        };
        const btnRadius = radiusMap[radius] || '99px';
        resetBtn.style.borderRadius = btnRadius;
        
        // Simple hover effect based on accent color
        resetBtn.onmouseover = () => { 
            resetBtn.style.color = isDark ? '#fff' : '#000';
            resetBtn.style.borderColor = accentColor; 
            resetBtn.style.background = isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)';
        };
        resetBtn.onmouseout = () => { 
            resetBtn.style.color = isDark ? '#888' : '#666'; 
            resetBtn.style.borderColor = isDark ? '#444' : 'rgba(0,0,0,0.1)';
            resetBtn.style.background = 'transparent';
        };

        // Container is now full height and transparent, so we don't apply radius to it.
    }

    resetBtn.addEventListener('click', () => {
        // Reset to original default theme
        // We ensure we deep clone again to prevent reference issues
        // CRITICAL: We must explicitly nullify keys that might have been added by a custom theme
        // but don't exist in the default theme (like 'color' or 'density'), otherwise
        // a deep merge in the SDK might preserve them.
        const cleanTheme = {
            ...JSON.parse(JSON.stringify(defaultTheme)),
            color: undefined,   
            density: undefined,
            // Add any other potential keys to clear if known
        };

        currentOptions = {
            ...currentOptions,
            theme: cleanTheme
        };
        
        // Re-inject the default fonts
        if (defaultTheme.typography && defaultTheme.typography.fontSources) {
            loadDynamicFonts(defaultTheme.typography.fontSources);
        }

        // Update SDK
        // Note: passing 'undefined' keys might be stripped by JSON serialization or handled as 'remove' by the SDK
        chat.setOptions(currentOptions);
        
        // Update UI
        updateThemeState();
        
        console.log("Theme reset to default.");
    });

    themeBtn.addEventListener('click', () => {
        const isDark = (currentOptions.theme && currentOptions.theme.colorScheme === 'dark');
        const newScheme = isDark ? 'light' : 'dark';
        
        // Update local options
        currentOptions = {
            ...currentOptions,
            theme: {
                ...currentOptions.theme,
                colorScheme: newScheme
            }
        };
        
        // Apply to ChatKit
        chat.setOptions(currentOptions);
        
        // Update UI
        updateThemeState();
    });

    // Initial check
    updateThemeState();

    // Helper to load fonts dynamically
    function loadDynamicFonts(sources) {
        if (!sources || !Array.isArray(sources)) return;
        
        const styleId = 'theme-dynamic-fonts';
        let styleTag = document.getElementById(styleId);
        if (!styleTag) {
            styleTag = document.createElement('style');
            styleTag.id = styleId;
            document.head.appendChild(styleTag);
        }
        
        const cssRules = sources.map(font => `
            @font-face {
                font-family: '${font.family}';
                src: url('${font.src}') format('woff2');
                font-weight: ${font.weight || 400};
                font-style: ${font.style || 'normal'};
                font-display: ${font.display || 'swap'};
            }
        `).join('\n');
        
        styleTag.textContent = cssRules;
        console.log("Injected dynamic fonts:", sources.map(s => s.family));
    }

    // 6. LISTEN FOR CLIENT EFFECTS
    // This allows the server to change the UI look and feel or trigger local logic.
    chat.addEventListener('chatkit.effect', (event) => {
        const { name, data } = event.detail;
        
        if (name === 'update_ui_theme') {
            console.log("Applying theme with typography:", data);
            
            // 0. Inject Fonts immediately so they are available
            if (data.typography && data.typography.fontSources) {
                loadDynamicFonts(data.typography.fontSources);
            }

            // 1. Update the local configuration object
            currentOptions = {
                ...currentOptions,
                theme: {
                    ...currentOptions.theme, // Preserve existing properties first
                    ...data,                 // Overwrite with new data
                    // If data.typography is present, we might want to be careful, but usually it's an object replacement.
                    // If data.typography is undefined, we keep the old one (via ...currentOptions.theme).
                    // If data.typography is defined, it overwrites.
                    typography: data.typography || currentOptions.theme.typography
                }
            };
            
            // 2. Trigger the SDK update
            chat.setOptions(currentOptions);
            
            // 3. Optional: Force a small layout check to ensure fonts apply
            console.log("Design system refreshed.");

            // 4. Update the toggle button to reflect external changes
            updateThemeState();
        }
    });

    // Optional: Log errors for debugging
    chat.addEventListener('chatkit.error', (e) => {
        console.error("ChatKit Runtime Error:", e.detail.error);
    });

</script>

</body>
</html>